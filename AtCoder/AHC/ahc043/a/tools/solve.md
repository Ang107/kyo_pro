# AHC043 解法 (プレテスト 20 位)

## 0. 前提

- 駅・路線は一つの木のように設置する
- 駅の設置を止めるタイミングの考え方: 各駅を立てた時点で，得られる収益と損失は確定するので，利得の累積和を取り，それが最大値となる所まで駅を建てるのが最善になる．

## 1. データ整理

駅の設置可能な場所は $N^2=2500$ あるが，含まれる家・職場の集合がユニークな置き方はもっと少ない．
例: seed 0: 150 通り, seed 8: 1638 通り

後述するビームサーチでの遷移先の数を制限するためにも，ユニークな置き方のみを考えることにした．

## 2. 初期解（駅の設置場所の列）生成: 差分更新ビームサーチ

初期解を差分更新ビームサーチを用いて作った．
ビームサーチに，約 $1$ 秒を使った．

- 評価関数
  $1$ ターン当たりの収益 / 現在のターン数

- 遷移
  ユニークな設置方法の全通りについて，そこに駅を置くことを遷移とする．

- 現在のターン数の推定
  路線設置にかかるターン数は，それより前に置いた駅とのマンハッタン距離の最小値とした．
  駅・路線設置にかかる金額が貯まるまでのターン数については，現在の所持金と 1 ターン当たりの収益を管理することで計算可能．
  上の二つを元に，指定した場所に駅の設置が完了するまでにかかる経過ターン数を計算し，それを用いた．

- 重複除去
  既に訪問済みの座標の集合を zobrist_hash で管理した．

- ビーム幅
  私の実装では，実行時間が概ね $M,|unique|$ に比例しているようだったので，実行時間を揃えるために
  ビーム幅 = 定数 / $M$ / $|unique|$ とした．

- 解の列挙
  全ての家・職場を含むように駅を設置する，もしくは $T$ ターン経過した全てのノードについて，解を列挙した．(生スコアで重複除去)
  列挙した解のうち，最も生スコアが良いものを，山登りに用いる初期解とした．

## 3. 解の改善: 山登り

残った $2$ 秒を山登りに使う．
約 $10^4$ 回程度は回った．

- 近傍

  1. $i$ 番目に設置する予定の駅を， $j$ 番目に設置するように変更する．
  2. $i$ 番目に設置する予定の駅の場所を，マンハッタン距離 $2$ の範囲でランダムに移動する．

  確率は同じ．
  $1$ の近傍はスコア改善に繋がる．
  $2$ の近傍は，スコアは改善しないものの，同スコアで異なる状態を作ることができるので，結果的に 1 の近傍による改善を促進する効果があった．

- 評価関数
  シミュレートして生スコアを評価値とする．

- 路線の設置場所の決め方
  BFS して最も近い駅と繋ぐ．
  後で駅を設置予定のマスに重みづけを行い，通ったマスの重みの総和が大きくなるようなルートを採用した．

## 4. 全体を通して

ビーム & 山登りということで，速度がそのままスコアに直結する & 少しのスコア差が順位に響くので，定数倍高速化を頑張った．
